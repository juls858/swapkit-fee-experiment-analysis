# Weekly Execution Quality (EQ) CSV - Data Dictionary

This dictionary describes the CSV generated by:
`sql/execution_quality/weekly_eq_quotes.sql`
Output file: `outputs/weekly_eq_quotes.csv`

## Columns

- week_start (DATE): ISO week start (Monday) for aggregation period.
- provider_group (STRING): Normalized provider inferred from `providers`.
  - Values: `THORCHAIN`, `CHAINFLIP`, `NEAR`.
- size_bucket (STRING): USD order size bucket.
  - Bins: `[0,1k)`, `[1k,10k)`, `[10k,50k)`, `[50k,250k)`, `[250k,20M)`, `20M+`.
  - Computation: uses only quotes where either leg is a USD stable; otherwise excluded.
- routes (INTEGER): Count of quote routes contributing to the bucket.
- improvement_rate (FLOAT): Fraction of routes with positive EQ.
  - Definition: `SUM(eq_bps > 0) / COUNT(*)`.
- avg_eq_bps (FLOAT): Mean execution quality in basis points.
  - Definition: `AVG(eq_bps)`; where `eq_bps = -total_slippage_bps` from quotes.
- median_eq_bps (FLOAT): Median execution quality in basis points.
  - Definition: `P50(eq_bps)` via `APPROX_QUANTILES`.
- usd_volume (FLOAT): Sum of USD-sized orders in the bucket.
  - Definition: `SUM(order_usd)`; see Notes on USD sizing below.

## Methodology Notes

- EQ from quotes: We infer expected EQ using `eq_bps = -total_slippage_bps` so improvement is positive.
- USD sizing: `order_usd` is set when either `sell_asset` or `buy_asset` is a USD stable (USDT, USDC, DAI, USDD, "USD").
  - If neither leg is a stable, the route is excluded from size bucketing (no external price feeds used).
- Providers: Any variant that contains the token (e.g., `THORCHAIN_STREAMING`, `ONEINCH-THORCHAIN`) is grouped to the base provider.
- Time window: Last 90 days rolling from query execution.
- Filters: `status_code = 200` only.

## Caveats

- This CSV uses quotes only (no realized executions); it measures expected EQ implied by quotes.
- Non-USD pairs are excluded from size buckets; to include them, join to a price feed and recompute `order_usd`.
- Median is approximate (BigQuery `APPROX_QUANTILES`).

## Example Row

```
2025-10-27,THORCHAIN,[50k,250k),273639,0.9929,-11088.7667,94.6045,3.2038e10
```

Interpretation: In week starting 2025-10-27, THORCHAIN quotes in the $50kâ€“$250k bucket had ~273k routes, ~99.3% showed improvement, average EQ -11,089 bps (outliers in averages), median EQ ~94.6 bps, and ~$32.0B of sized volume.

## Reproducibility

- SQL: `sql/execution_quality/weekly_eq_quotes.sql`
- CLI: `bq query --use_legacy_sql=false --format=csv < sql/execution_quality/weekly_eq_quotes.sql > outputs/weekly_eq_quotes.csv`
